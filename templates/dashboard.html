{% extends "base.html" %}
{% block content %}

<style>
  body {
    background: radial-gradient(circle at 30% 30%, #ff9f1c, transparent 35%),
      radial-gradient(circle at 90% 20%, #b64f00, transparent 65%),
      linear-gradient(135deg, #2b4480, #020617);
  }
</style>

<div class="hero-banner mb-5">
  <div class="hero-overlay">
    <div class="hero-content">
      <h1>Welcome, {{ session.user_name }} üëã</h1>
      <p>Rent premium cars & bikes at affordable prices.
        Fast booking ‚Ä¢ Easy refunds ‚Ä¢ 24√ó7 availability</p>


      <div class="hero-stats mt-3">
        <span class="badge bg-light text-dark me-2">
          üöó 50+ Vehicles
        </span>
        <span class="badge bg-light text-dark me-2">
          ‚ö° Instant Booking
        </span>
        <span class="badge bg-light text-dark">
          üí∏ Easy Refunds
        </span>
      </div>

    </div>
  </div>
</div>

<div class="container-fluid">


  <!-- ================= FILTER BAR ================= -->
  <form method="get" class="row g-3 mb-4 align-items-end">

    <div class="col-md-3">
      <label class="form-label">Sort by</label>
      <select name="sort" class="form-control">
        <option value="">Default</option>
        <option value="price_low" {% if sort=='price_low' %}selected{% endif %}>
          Price: Low ‚Üí High
        </option>
        <option value="price_high" {% if sort=='price_high' %}selected{% endif %}>
          Price: High ‚Üí Low
        </option>
      </select>
    </div>

    <div class="col-md-3">
      <label class="form-label">Availability</label>
      <select name="availability" class="form-control">
        <option value="">All</option>
        <option value="available" {% if availability=='available' %}selected{% endif %}>
          Available Only
        </option>
      </select>
    </div>

    <div class="col-md-2">
      <button class="btn btn-primary w-100">Apply</button>
    </div>

  </form>

  <!-- ================= CARS ================= -->
  <h4 class="mb-4">Available Cars & Bikes</h4>

  <div class="row g-4">
    {% for car in cars %}
    <div class="col-md-4 col-lg-3">

      <div class="card shadow h-100">

        <img src="{{ url_for('static', filename='cars/' + car[4]) }}" class="card-img-top" alt="{{ car[1] }}"
          style="height:180px; object-fit:cover;">

        <div class="card-body d-flex flex-column">

          <h5 class="mb-1">{{ car[1] }}</h5>



          <!-- DISCOUNT -->
          {% if car[5] > 0 %}
          <p class="mb-1">
            <span class="text-muted text-decoration-line-through">
              ‚Çπ {{ car[2] }}
            </span>
            <span class="fw-bold text-success ms-2">
              ‚Çπ {{ car[2] - (car[2] * car[5] // 100) }}
            </span>
            <small class="text-success">/ day</small>
            <span class="badge bg-info mb-2">{{ car[5] }}% OFF</span>
            {% else %}
          <p class="text-muted">‚Çπ {{ car[2] }} / day</p>
          </p>

          {% endif %}


          <!-- AVAILABILITY -->
          {% if car[3] == 1 %}
          <span class="badge bg-success mb-2">Available</span>
          {% else %}
          <span class="badge bg-danger mb-2">Booked</span>
          {% endif %}

          <!-- ACTION -->
          <div class="mt-auto">
            {% if car[3] == 1 %}
            <a href="/book/{{ car[0] }}" class="btn btn-primary w-100">
              Book Now
            </a>
            {% else %}
            <button class="btn btn-secondary w-100" disabled>
              Not Available
            </button>
            {% endif %}
          </div>

        </div>
      </div>

    </div>
    {% endfor %}
  </div>

  <!-- ================= MY BOOKINGS ================= -->
  <h4 class="mt-5 mb-3">My Bookings</h4>

  {% if bookings %}
  <div class="table-responsive">
    <table class="table shadow">
      <thead>
        <tr>
          <th>ID</th>
          <th>Days</th>
          <th>Total</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>

        {% for b in bookings %}
        <tr>
          <td>#{{ b[0] }}</td>
          <td>{{ b[3] }}</td>
          <td>‚Çπ {{ b[4] }}</td>

          <!-- STATUS COLUMN -->
          <td>
            {% if b[7] == 'Booked' %}
            <span class="badge bg-info">Booked</span>
            {% elif b[7] == 'Paid' %}
            <span class="badge bg-success">Paid</span>
            {% elif b[7] == 'Returned' %}
            <span class="badge bg-secondary">Returned</span>
            {% elif b[7] == 'Cancelled' %}
            <span class="badge bg-danger">Cancelled</span>
            {% else %}
            ‚Äî
            {% endif %}
          </td>

          <!-- ACTION COLUMN -->
          <td>
            {% if b[7] == 'Booked' %}
            <a href="/payment/{{ b[0] }}" class="btn btn-sm btn-success mb-1">Pay</a>
            <button class="btn btn-sm btn-outline-danger" onclick="cancelBooking({{ b[0] }})">Cancel</button>

            {% elif b[7] == 'Paid' %}
            <button class="btn btn-sm btn-warning mb-1" onclick="deliverCar({{ b[0] }}, this)">üì¶ Deliver Back</button>
            <button class="btn btn-sm btn-outline-danger" onclick="cancelBooking({{ b[0] }})">Cancel</button>

            {% elif b[7] == 'Returned' or b[7] == 'Cancelled' %}
            ‚Äî
            {% endif %}
          </td>
        </tr>
        {% endfor %}

      </tbody>
    </table>
  </div>
  {% else %}
  <div class="card p-5 text-center text-muted">
    <h6>No active bookings yet</h6>
  </div>
  {% endif %}

</div>
<script>
  function deliverCar(bookingId, btn) {
  if (!confirm("Are you sure you want to return this car?")) {
    return;
  }

  btn.disabled = true;
  btn.innerText = "Processing...";

  fetch(`/delivered/${bookingId}`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    }
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      const row = btn.closest("tr");
      // Update status
      row.querySelector("td:nth-child(4)").innerHTML =
        '<span class="badge bg-secondary">Returned</span>';
      // Remove entire actions cell content
      row.querySelector("td:nth-child(5)").innerHTML = '‚Äî';
    } else {
      btn.disabled = false;
      btn.innerText = "üì¶ Deliver Back";
      alert("Something went wrong");
    }
  })
  .catch(() => {
    btn.disabled = false;
    btn.innerText = "üì¶ Deliver Back";
    alert("Server error");
  });
}

</script>


<script>
  function cancelBooking(bookingId) {
    if (!confirm("Are you sure you want to cancel this booking?")) {
      return;
    }

    fetch(`/cancel_booking/${bookingId}`, {
      method: "POST"
    })
      .then(res => res.json())
      .then(data => {
        // ‚ùå silently fail if not allowed
        if (!data.success) {
          return;
        }

        const row = document
          .querySelector(`button[onclick="cancelBooking(${bookingId})"]`)
          .closest("tr");

        const statusCell = row.querySelector("td:nth-child(4)");
        const actionCell = row.querySelector("td:nth-child(5)");

        if (data.was_paid) {
          statusCell.innerHTML =
            '<span class="badge bg-warning">Refunding</span>';
        } else {
          statusCell.innerHTML =
            '<span class="badge bg-danger">Cancelled</span>';
        }

        actionCell.innerHTML = "‚Äî";
      })
      .catch(() => {
        // ‚ùå no alert
      });
  }
</script>




{% endblock %}